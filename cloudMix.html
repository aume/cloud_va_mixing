<!DOCTYPE html>
<html>
<head>
	<title></title>

	<link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
    <link href="_css/mainStyle.css" rel="stylesheet" type="text/css">
    <link href="_css/graph.css" rel="stylesheet" type="text/css"/>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">


	<style type="text/css">
	body{
		background-color: 'white' ;
	}
        text:hover { 
            opacity: 1 ; 
            transition: font 0.1s ease;
        }
        

        #words_container{
            float: left;
            display: block;
            width: 100%;
            border: solid;
            background-color: white;
        }

        #cloud {
        	float: left;
        	display: inline-block;
            width: 50%;
            border-bottom: solid;
        }
        #words{
            float: right;
            width: 50%;
        }
        #words li {
            display: block;
            width: 25%;
            float: left;
            font-family: sans-serif;
        }
        #words li:hover {
            color: pink ;
        }

        #category{
            min-height: 2em;
            border-bottom: dashed;
            border-right: dashed;
        }
        #query {
            min-height: 2em;
            border-bottom: solid;
        }
        
    </style>

</head>
<body>


<!--Mixer Container-->

    <nav id="nav"></nav>
	<div class="container">
        <img src="img/AuMeLogo.png" style="display: block; width: 80%;"/>

	    <div id="controls">
	        <!-- <img src="img/information-icon.png" title="hint text" class="topRight" /> -->
	        <!--input type="text" id="concept" class="half" placeholder="Enter the concept" title="placeholder hint text"-->

	        <span class="half">Duration: <input type="range" id="timescale" value="60" min="20" max="120"/> <label
	                for="timescale" id="timescaleLabel">Current value: </label></span>
	    </div>

	    <div class="graphContainer clearfix" id="lineEditorContainer">
	        <!-- <img src="img/information-icon.png" title="Click anywhere on the graph to add a point to the currently selected line. Click on any point and press
	            Delete to remove it (Except first and last points)" class="topRight" /> -->
	        <div id="graph"></div>
	    </div>

	    <div>
		    <input type="button" value="Get Mix" onclick="makeTracks()">
			<input type="button" value="Make Mix" onclick="getItgoing()">
			<input type="button" value="Start Audio" onclick="controlmix.start()">
			<input type="button" value="Stop Audio" onclick="controlmix.start()">
		</div>
		<div id="words_container" class="clearfix">
            <img src="img/loading.gif" style="display: block;" id="wordsLoadingSpinner"/>

		    <div id="query"></div>
		    <div id="category"></div>
		    <div id="words"></div>
		    <div id="cloud"></div>
		</div>

	    <div class="graphContainer" id="trackDisplayContainer" style="display:none;">
            <img src="img/loading.gif" style="display: none;" id="tracksLoadingSpinner"/>

	        <!-- <img src="img/information-icon.png" title="hint text" class="topRight" /> -->
	        <div id="trackGraph"></div>
	    </div>


	</div>  <!-- end .container -->






<script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
<script
        src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"
        integrity="sha256-xNjb53/rY+WmG+4L6tTl9m6PpqknWZvRt0rO1SRnJzw="
        crossorigin="anonymous"></script>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="js/d3.layout.cloud.js"></script>

<script src="./js/buff2Wav.js"></script>
<script src="./js/FileSaver.js"></script>
<script src="./js/meyda.js"></script>
<script src="./js/math.min.js"></script>

<script src="js/draggraph.js"></script>
<script src="js/trackdisplay.js"></script>

<script src="./js/sql.js"></script>
<script src="./js/database.js"></script>
<script src='./js/wordCloudSearch.js'></script>

<script src="./js/roughmix.js"></script>
<script src="./js/audioSegmentLoader.js"></script>>
<script src="./js/web-audio-scheduler.js"></script>



<script src="./js/controlmix.js"></script>
<script src="./js/audiotrack.js"></script>
<script src="./js/extractor.js"></script>
<script src="./js/meter.js"></script>

<script type="text/javascript">
	
var fileLocation = "http://digitalmedia.ok.ubc.ca/Freesound/";//"file:///Volumes/pimpernel/Resources/Freesound/" ;
//

var audioCtx = new AudioContext() ; // the main audio context


var controlmix = null;
var searcher = null ; //
var segmentPool = {} ;
var tracks = null ;
var countDownTillLaunch = 0 ; // index for xhr callbacks
var graph = null;
var width = null ;


initdb(initApp) ;

// initApp -> (click) makeTracks -> (compileSegments) populateTracks -> (click) playSong 

function initApp(argument) {
	
	searcher = new WordCloudSearch() ;
	searcher.loadWords() ;
    hide('wordsLoadingSpinner') ;

	var width = $("#graph").width();
	var valence = [[0, 1], [30, 0.4], [60, 1]];
    var arousal = [[0, 0], [30, .5], [60, 0]];
    graph = new DragLineGraph({
        width: width,
        height: 200
    }).data([valence, arousal]).legend(["Valance", "Arousal"]);
    graph("#graph");

    $("#timescale").change(function () {
        $("#timescaleLabel").text("Length: " + this.value + "s");
        graph.timescale(this.value);
    });

    // Update label
    $("#timescale").on("input", function () {
        $("#timescaleLabel").text("Length: " + this.value + "s");
        graph.timescale(this.value);
    });
    $("#timescale").change();

    $( document ).tooltip({
        content:function(){
            return this.getAttribute("title");
        }
    });
}// end initApp


function hide(elementName) {
    var x = document.getElementById(elementName);
    if (x.style.display === 'none') {
        x.style.display = 'block';
    } else {
        x.style.display = 'none';
    }
} 
//
//
// Search and Load section
//
//
// callback from audioSegmentLoader - loadsplit()

function getItgoing() {
	controlmix = new ControlMix(tracks)
}

function playMix() {
	controlmix.start() ;
}

function compileSegmentLoads(data) {
	Object.assign(segmentPool, data) ;
	countDownTillLaunch -- ;
	if(!countDownTillLaunch) {
		console.log('DONE', 'segmentPool', segmentPool, 'tracks', tracks, 'VA', graph.data()) ;//populateTracks(mix) ;
		//getItgoing()
	}
}

function makeTracks() {
	console.log('making tracks') ;
	hide('words_container') ;
    hide('tracksLoadingSpinner') ;
	var mix = new RoughMix() ;
	let words = searcher.getFormattedQuery() ;
	let va = graph.data() ;
	let duration = document.getElementById("timescale").value ;

	tracks = mix.generateMix(words, parseInt(duration), va[0], va[1]) ;
	let segmentData = mix.getSegmentsFromTracks(tracks) ;
	countDownTillLaunch = Object.keys(segmentData).length ;

	console.log('tracks', tracks)
	console.log('segmentData', segmentData)
	console.log('countDownTillLaunch', countDownTillLaunch)

	populateTracks(tracks);

	// get all the samples
	for(let key in segmentData) {
		let urlLocation = fileLocation+Object.keys(segmentData)[0] ;
		loadsplit(urlLocation, segmentData[key].data, compileSegmentLoads) ;
	}
	
} // end make tracks

function populateTracks(tracks) {
	let duration = document.getElementById("timescale").value ;
	var trackGraph = new TrackDisplay({width: width,timescale:duration});
    trackGraph.tracks(tracks);
    trackGraph.drawGraph("#trackGraph")
    hide('tracksLoadingSpinner') ;
} // end populateTracks



</script>

<script type="text/javascript">
//https://www.w3schools.com/howto/howto_js_accordion.asp

</script>


</body>
</html>